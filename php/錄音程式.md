# éŒ„éŸ³ç¨‹å¼ç³»çµ± (Voice Recording System)

## ç³»çµ±æ¶æ§‹ï¼šé›™è»Œç³»çµ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      voice-sync ç³»çµ±                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Telegram è»Œé“       â”‚    â”‚  Web UI è»Œé“               â”‚  â”‚
â”‚  â”‚  (/phonetts)        â”‚    â”‚  (upload.php)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                           â”‚                       â”‚
â”‚           â–¼                           â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ OpenClaw æ¥æ”¶       â”‚    â”‚ ç€è¦½å™¨ä¸Šå‚³                  â”‚  â”‚
â”‚  â”‚ â†’ temp/telegram-   â”‚    â”‚ â†’ NAS data/recordings/      â”‚  â”‚
â”‚  â”‚    file/           â”‚    â”‚                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                              â”‚                   â”‚
â”‚            â–¼                              â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æœ¬æ©Ÿ Whisper è½‰éŒ„   â”‚    â”‚ OpenAI Whisper API è½‰éŒ„     â”‚  â”‚
â”‚  â”‚ (å…è²»ï¼Œæœ¬æ©Ÿéƒ¨ç½²)     â”‚    â”‚ ($0.006/åˆ†é˜)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                              â”‚                   â”‚
â”‚            â–¼                              â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ åŒæ­¥åˆ° NAS          â”‚    â”‚ ç”Ÿæˆ .md æ–‡å­—ç¨¿              â”‚  â”‚
â”‚  â”‚ â€¢ backups/          â”‚    â”‚ â€¢ data/transcripts/         â”‚  â”‚
â”‚  â”‚ â€¢ data/            â”‚    â”‚ â€¢ æ›´æ–° index.json            â”‚  â”‚
â”‚  â”‚ â€¢ æ›´æ–° index.json  â”‚    â”‚ â€¢ status: done              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸Šå‚³æ–¹å¼å°ç…§è¡¨

| é …ç›® | Telegram (/phonetts) | Web UI (upload.php) |
|------|---------------------|----------------------|
| è¼¸å…¥ä¾†æº | Telegram éŒ„éŸ³æª” | ç€è¦½å™¨é¸æ“‡æª”æ¡ˆ |
| è½‰éŒ„æ–¹å¼ | **æœ¬æ©Ÿ Whisper** | **OpenAI API** |
| è²»ç”¨ | **å…è²»** | $0.006/åˆ†é˜ |
| éŒ„éŸ³å„²å­˜ | `backups/{filename}_{timestamp}.m4a` | `recordings/{id}.m4a` |
| æ–‡å­—ç¨¿ä½ç½® | `data/transcripts/{id}.md` | `data/transcripts/{id}.md` |
| æ’­æ”¾/ä¸‹è¼‰ | âœ… æ”¯æ´ | âœ… æ”¯æ´ |
| æª”æ¡ˆé™åˆ¶ | ç„¡é™åˆ¶ | **æœ€å¤§ 25MB** |

---

## /phonetts æœ¬æ©Ÿç¨‹å¼ (OpenClaw Skill)

### åŠŸèƒ½èªªæ˜
- æ¥æ”¶ Telegram éŒ„éŸ³æª” (m4a/mp3)
- ä½¿ç”¨ Whisper æœ¬æ©Ÿè½‰æ–‡å­—
- ç”¢ç”Ÿ `.md` æ–‡å­—ç¨¿
- æ›´æ–° `index.json` ç´¢å¼•
- éŒ„éŸ³æª”å‚™ä»½åˆ° NAS `backups/` ç›®éŒ„
- åˆªé™¤æœ¬æ©Ÿå¿«å–ï¼Œé¿å…é‡è¤‡è™•ç†
- **ä½¿ç”¨ç¨ç«‹ç›®éŒ„ `telegram-file/`**ï¼Œèˆ‡ youtube-video-summary å€åˆ†

### è§¸ç™¼æ–¹å¼
- **æŒ‡ä»¤**: `/phonetts` æˆ–ç›´æ¥å‚³é€éŒ„éŸ³æª”

### å·¥ä½œæµç¨‹

```
1. /phonetts
2. å›è¦†ã€Œè«‹å‚³è¼¸éŒ„éŸ³æª”ã€
3. ç”¨æˆ¶å‚³é€éŒ„éŸ³æª”
4. å›è¦†ã€Œè™•ç†éŒ„éŸ³ä¸­...ã€
5. å®Œæˆå¾Œå›å ±çµæœ
```

### æœ¬æ©Ÿç›®éŒ„çµæ§‹
```
C:\Users\linyi\.openclaw\workspace\
â”œâ”€â”€ temp/
â”‚   â”œâ”€â”€ telegram-file/           # Telegram éŒ„éŸ³æª”ï¼ˆç¨ç«‹ç›®éŒ„ï¼‰
â”‚   â”‚   â”œâ”€â”€ recording.m4a      # è‡¨æ™‚éŒ„éŸ³æª”
â”‚   â”‚   â”œâ”€â”€ audio.wav            # FFmpeg è½‰æ›å¾Œ
â”‚   â”‚   â””â”€â”€ transcript.json      # Whisper è¼¸å‡º
â”‚   â””â”€â”€ data/
â”‚       â”œâ”€â”€ index.json          # ç´¢å¼•è³‡æ–™åº«
â”‚       â””â”€â”€ transcripts/        # æ–‡å­—ç¨¿
â”‚           â””â”€â”€ {id}.md
â”œâ”€â”€ transcribe.py                 # Whisper è½‰æ–‡å­—
â””â”€â”€ skills/phonetts/           # Skill æª”æ¡ˆ
```

---

## Web ä¸Šå‚³ç¨‹å¼ (upload.php)

### åŠŸèƒ½èªªæ˜
- æ”¯æ´ç€è¦½å™¨é¸æ“‡æª”æ¡ˆä¸Šå‚³
- æ”¯æ´ iOS é•·æŒ‰éŒ„éŸ³
- **è‡ªå‹•èª¿ç”¨ OpenAI Whisper API è½‰éŒ„**
- ç”¢ç”Ÿ `.md` æ–‡å­—ç¨¿
- æ”¯æ´ **ğŸµ æ’­æ”¾** å’Œ **â¬‡ï¸ ä¸‹è¼‰**
- **25MB æª”æ¡ˆå¤§å°é™åˆ¶**

### æ”¯æ´æ ¼å¼
- M4Aã€MP3ã€WAVã€M4B
- æœ€å¤§æª”æ¡ˆå¤§å°ï¼š**25MB**

### å·¥ä½œæµç¨‹

```
é¸æ“‡æª”æ¡ˆ â†’ ä¸Šå‚³ä¸¦è½‰éŒ„ä¸­... â†’ å®Œæˆï¼
                          â†“
                    status: done âœ…
                          â†“
              ğŸµ æ’­æ”¾ | â¬‡ï¸ ä¸‹è¼‰
```

### upload.php å®Œæ•´ç¨‹å¼ç¢¼

```php
<?php
error_reporting(0);
ini_set('display_errors', 0);

require_once 'config.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['audio'])) {
    header('Content-Type: application/json; charset=UTF-8');
    
    $file = $_FILES['audio'];
    $originalName = basename($file['name']);
    $fileId = time() . '_' . substr(md5($originalName), 0, 8);
    $extension = strtolower(pathinfo($originalName, PATHINFO_EXTENSION)) ?: 'm4a';
    
    // æª¢æŸ¥æª”æ¡ˆå¤§å°é™åˆ¶ (25MB)
    $maxSize = 25 * 1024 * 1024; // 25MB in bytes
    if ($file['size'] > $maxSize) {
        echo json_encode(['success' => false, 'message' => 'æª”æ¡ˆå¤§å°è¶…éé™åˆ¶ï¼æœ€å¤§æ”¯æ´ 25MBã€‚']);
        exit;
    }
    
    if ($file['error'] !== UPLOAD_ERR_OK) {
        echo json_encode(['success' => false, 'message' => 'Upload error: ' . $file['error']]);
        exit;
    }
    
    $recordingsPath = RECORDINGS_DIR . '/' . $fileId . '.' . $extension;
    
    if (move_uploaded_file($file['tmp_name'], $recordingsPath)) {
        // Web ä¸Šå‚³çš„å‚™ä»½è·¯å¾‘ï¼ˆç›´æ¥æŒ‡å‘ recordingsï¼‰
        $backupPath = 'recordings/' . $fileId . '.' . $extension;
        
        // æ›´æ–° index.json - å…ˆè¨­ç‚º pending
        $index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
        $index['files'][] = [
            'id' => $fileId,
            'filename' => $originalName,
            'path' => 'recordings/' . $fileId . '.' . $extension,
            'backup_path' => $backupPath,
            'transcript_path' => 'transcripts/' . $fileId . '.md',
            'date' => date('Y-m-d H:i:s'),
            'duration' => 0,
            'size' => filesize($recordingsPath),
            'status' => 'pending'
        ];
        file_put_contents(INDEX_FILE, json_encode($index, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
        
        // èª¿ç”¨ OpenAI Whisper API é€²è¡Œè½‰éŒ„
        $transcriptPath = TRANSCRIPTS_DIR . '/' . $fileId . '.md';
        $transcriptContent = transcribeWithOpenAI($recordingsPath, $originalName);
        
        if ($transcriptContent) {
            // è½‰éŒ„æˆåŠŸ - æ›´æ–°ç‚º done
            file_put_contents($transcriptPath, $transcriptContent);
            
            // æ›´æ–° status ç‚º done
            foreach ($index['files'] as &$f) {
                if ($f['id'] === $fileId) {
                    $f['status'] = 'done';
                    break;
                }
            }
            file_put_contents(INDEX_FILE, json_encode($index, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
            
            echo json_encode(['success' => true, 'id' => $fileId, 'message' => 'ä¸Šå‚³ä¸¦è½‰éŒ„æˆåŠŸï¼', 'filename' => $originalName]);
        } else {
            echo json_encode(['success' => true, 'id' => $fileId, 'message' => 'ä¸Šå‚³æˆåŠŸï¼Œè½‰éŒ„å¤±æ•—ï¼ˆè«‹ç¨å¾Œæ‰‹å‹•è½‰éŒ„ï¼‰', 'filename' => $originalName]);
        }
    } else {
        echo json_encode(['success' => false, 'message' => 'move_uploaded_file failed']);
    }
    exit;
}

// OpenAI Whisper API è½‰éŒ„å‡½æ•¸
function transcribeWithOpenAI($audioPath, $filename) {
    if (!defined('OPENAI_API_KEY') || !defined('OPENAI_API_URL')) {
        error_log('OpenAI API config not found');
        return false;
    }
    
    $apiKey = OPENAI_API_KEY;
    $url = OPENAI_API_URL;
    
    $cfile = new CURLFile($audioPath, mime_content_type($audioPath), $filename);
    
    $postData = [
        'model' => 'whisper-1',
        'file' => $cfile,
        'language' => 'zh',
        'response_format' => 'verbose_json',
        'temperature' => 0
    ];
    
    $ch = curl_init($url);
    curl_setopt_array($ch, [
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => $postData,
        CURLOPT_HTTPHEADER => [
            'Authorization: Bearer ' . $apiKey
        ],
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT => 120
    ]);
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);
    curl_close($ch);
    
    if ($error || $httpCode !== 200) {
        error_log('OpenAI API error: ' . $response);
        return false;
    }
    
    $data = json_decode($response, true);
    if (!$data || !isset($data['text'])) {
        return false;
    }
    
    $duration = $data['duration'] ?? 0;
    $text = $data['text'] ?? '';
    
    $mdContent = "# {$filename}\n\n";
    $mdContent .= "## è³‡è¨Š\n";
    $mdContent .= "- **æ—¥æœŸ**: " . date('Y-m-d H:i:s') . "\n";
    $mdContent .= "- **æª”å**: {$filename}\n";
    $mdContent .= "- **é•·åº¦**: " . round($duration) . " ç§’\n\n";
    $mdContent .= "## è½‰éŒ„å…§å®¹\n\n{$text}\n\n";
    $mdContent .= "---\n";
    $mdContent .= "*è½‰éŒ„æ™‚é–“: " . date('Y-m-d H:i:s') . "*\n";
    $mdContent .= "*è½‰éŒ„å·¥å…·: OpenAI Whisper API*\n";
    
    return $mdContent;
}
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šå‚³éŒ„éŸ³</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 100%; text-align: center; }
        h1 { color: #333; margin-bottom: 30px; }
        .upload-area { border: 3px dashed #667eea; border-radius: 15px; padding: 40px 20px; margin-bottom: 20px; cursor: pointer; background: #f8f9fa; }
        .upload-area:hover { border-color: #764ba2; background: #f0f0ff; }
        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        .upload-text { color: #666; margin-bottom: 10px; }
        .upload-hint { font-size: 12px; color: #999; }
        input[type="file"] { display: none; }
        .recording-btn { width: 80px; height: 80px; border-radius: 50%; background: #dc3545; border: none; color: white; font-size: 14px; cursor: pointer; margin: 10px; }
        .recording-btn.recording { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .result { margin-top: 20px; padding: 15px; border-radius: 10px; display: none; }
        .result.success { background: #d4edda; color: #155724; display: block; }
        .result.error { background: #f8d7da; color: #721c24; display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ ä¸Šå‚³éŒ„éŸ³</h1>
        <div class="upload-area" onclick="document.getElementById('audioInput').click()">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">é»æ“Šé¸æ“‡éŒ„éŸ³æª”</div>
            <div class="upload-hint">æ”¯æ´ M4Aã€MP3ã€WAVï¼ˆæœ€å¤§ 25MBï¼‰</div>
        </div>
        <input type="file" id="audioInput" accept="audio/*,.m4a,.mp3,.wav" onchange="uploadFile(this)">
        <div id="fileInfo" style="font-size: 12px; color: #666; margin-top: 10px;"></div>
        <div style="margin: 20px 0; color: #999;">â€” æˆ– â€”</div>
        <button class="recording-btn" id="recordBtn" onmousedown="startRecording()" ontouchstart="startRecording(event)" onmouseup="stopRecording()" ontouchend="stopRecording(event)">ğŸ™<br>é•·æŒ‰éŒ„éŸ³</button>
        <div id="recordingStatus" style="font-size: 12px; color: #666;"></div>
        <div id="result" class="result"></div>
    </div>
    <script>
        let mediaRecorder = null, audioChunks = [];
        const MAX_SIZE = 25 * 1024 * 1024; // 25MB
        
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function uploadFile(input) {
            if (input.files.length > 0) {
                const file = input.files[0];
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = 'æª”æ¡ˆå¤§å°: ' + formatSize(file.size);
                
                if (file.size > MAX_SIZE) {
                    fileInfo.style.color = '#dc3545';
                    fileInfo.innerHTML += ' âš ï¸ è¶…é 25MB é™åˆ¶ï¼Œç„¡æ³•ä¸Šå‚³';
                    input.value = '';
                    return;
                }
                
                const formData = new FormData();
                formData.append('audio', file);
                input.disabled = true;
                document.getElementById('result').className = 'result';
                document.getElementById('result').innerHTML = 'ä¸Šå‚³ä¸¦è½‰éŒ„ä¸­...è«‹ç¨å€™';
                document.getElementById('result').style.display = 'block';
                
                fetch('upload.php', { method: 'POST', body: formData })
                .then(r => r.text())
                .then(t => {
                    try { return JSON.parse(t); }
                    catch(e) { throw new Error('Non-JSON: ' + t.substring(0, 100)); }
                })
                .then(d => {
                    input.disabled = false;
                    if (d.success) {
                        document.getElementById('result').className = 'result success';
                        document.getElementById('result').innerHTML = 'âœ… ' + d.message;
                        setTimeout(() => location.href = 'index.php', 2000);
                    } else {
                        document.getElementById('result').className = 'result error';
                        document.getElementById('result').innerHTML = 'âŒ ' + d.message;
                    }
                })
                .catch(e => {
                    input.disabled = false;
                    document.getElementById('result').className = 'result error';
                    document.getElementById('result').innerHTML = 'âŒ ' + e.message;
                });
            }
        }
        
        function startRecording(e) {
            if (e) e.preventDefault();
            navigator.mediaDevices.getUserMedia({ audio: true })
            .then(s => {
                mediaRecorder = new MediaRecorder(s);
                audioChunks = [];
                mediaRecorder.ondataavailable = ev => {
                    audioChunks.push(ev.data);
                    const blob = new Blob(audioChunks, { type: 'audio/m4a' });
                    if (blob.size > MAX_SIZE) {
                        mediaRecorder.stop();
                        document.getElementById('recordingStatus').innerHTML = 'âš ï¸ éŒ„éŸ³è¶…é 25MBï¼Œè«‹ç¸®çŸ­éŒ„éŸ³æ™‚é–“';
                        document.getElementById('recordBtn').classList.remove('recording');
                        s.getTracks().forEach(t => t.stop());
                    }
                };
                mediaRecorder.onstop = () => {
                    const b = new Blob(audioChunks, { type: 'audio/m4a' });
                    const f = new File([b], 'éŒ„éŸ³_' + Date.now() + '.m4a', { type: 'audio/m4a' });
                    const fd = new FormData();
                    fd.append('audio', f);
                    document.getElementById('recordingStatus').innerHTML = 'ä¸Šå‚³ä¸¦è½‰éŒ„ä¸­...è«‹ç¨å€™';
                    fetch('upload.php', { method: 'POST', body: fd })
                    .then(r => r.text())
                    .then(t => {
                        try { return JSON.parse(t); }
                        catch(e) { throw new Error('Non-JSON'); }
                    })
                    .then(d => {
                        document.getElementById('recordingStatus').innerHTML = '';
                        if (d.success) {
                            document.getElementById('result').className = 'result success';
                            document.getElementById('result').innerHTML = 'âœ… ' + d.message;
                            setTimeout(() => location.href = 'index.php', 2000);
                        } else {
                            document.getElementById('result').className = 'result error';
                            document.getElementById('result').innerHTML = 'âŒ ' + d.message;
                        }
                    })
                    .catch(() => {
                        document.getElementById('recordingStatus').innerHTML = '';
                        document.getElementById('result').className = 'result error';
                        document.getElementById('result').innerHTML = 'âŒ ä¸Šå‚³å¤±æ•—';
                    });
                    s.getTracks().forEach(t => t.stop());
                };
                mediaRecorder.start();
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordingStatus').innerHTML = 'éŒ„éŸ³ä¸­...è«‹èªªè©±';
            })
            .catch(() => document.getElementById('recordingStatus').innerHTML = 'âš ï¸ ç„¡æ³•è¨ªå•éº¥å…‹é¢¨');
        }
        
        function stopRecording(e) {
            if (e) e.preventDefault();
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('recordBtn').classList.remove('recording');
            }
        }
    </script>
</body>
</html>
```

---

## index.phpï¼ˆæª”æ¡ˆåˆ—è¡¨ï¼‰

### åŠŸèƒ½èªªæ˜
- é¡¯ç¤ºæ‰€æœ‰éŒ„éŸ³æª”åˆ—è¡¨
- æª”å**æ°¸é é¡¯ç¤ºè¶…é€£çµ**ï¼ˆå³ä½¿ pendingï¼‰
- pending æª”æ¡ˆé¡¯ç¤º `(å¾…è½‰éŒ„)` æ¨™ç±¤
- æ”¯æ´åˆ†é å’Œæœå°‹

### ç¨‹å¼ç¢¼

```php
<?
require_once 'config.php';

$index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
$files = $index['files'] ?? [];

usort($files, function($a, $b) {
    return strtotime($b['date']) - strtotime($a['date']);
});

$page = max(1, intval($_GET['page'] ?? 1));
$totalPages = ceil(count($files) / ITEMS_PER_PAGE);
$start = ($page - 1) * ITEMS_PER_PAGE;
$pageFiles = array_slice($files, $start, $ITEMS_PER_PAGE);

function formatDuration($seconds) {
    $m = floor($seconds / 60);
    $s = $seconds % 60;
    return sprintf('%d:%02d', $m, $s);
}
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŒ„éŸ³æª”åˆ—è¡¨</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { color: #333; }
        .search { margin: 20px 0; }
        .search input { padding: 10px; width: 300px; border: 1px solid #ddd; border-radius: 4px; }
        .search button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; }
        tr:hover { background: #f8f9fa; }
        .duration { color: #666; }
        .pagination { margin: 20px 0; display: flex; gap: 5px; }
        .pagination a { padding: 8px 12px; background: white; border: 1px solid #ddd; text-decoration: none; color: #333; border-radius: 4px; }
        .pagination a.active { background: #007bff; color: white; border-color: #007bff; }
        .upload-btn { display: inline-block; padding: 10px 20px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; margin-left: 10px; }
        .filename { color: #007bff; text-decoration: none; }
        .filename:hover { text-decoration: underline; }
        .pending-tag { color: orange; font-size: 12px; margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>éŒ„éŸ³æª”åˆ—è¡¨</h1>
        
        <div class="search">
            <form method="GET" action="api.php">
                <input type="text" name="q" placeholder="æœå°‹éŒ„éŸ³å…§å®¹...">
                <button type="submit">æœå°‹</button>
            </form>
            <a href="upload.php" class="upload-btn">+ ä¸Šå‚³éŒ„éŸ³</a>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>æª”å</th>
                    <th>é•·åº¦</th>
                    <th>å¤§å°</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($pageFiles as $file): ?>
                <tr>
                    <td><?= htmlspecialchars($file['date']) ?></td>
                    <td>
                        <a href="view.php?id=<?= urlencode($file['id']) ?>" class="filename">
                            <?= htmlspecialchars($file['filename']) ?>
                        </a>
                        <?php if (($file['status'] ?? 'pending') === 'pending'): ?>
                        <span class="pending-tag">(å¾…è½‰éŒ„)</span>
                        <?php endif; ?>
                    </td>
                    <td class="duration"><?= formatDuration($file['duration']) ?></td>
                    <td><?= round($file['size'] / 1024) ?> KB</td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
        
        <div class="pagination">
            <?php for ($i = 1; $i <= $totalPages; $i++): ?>
                <a href="?page=<?= $i ?>" class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
            <?php endfor; ?>
        </div>
    </div>
</body>
</html>
```

---

## view.phpï¼ˆæ–‡å­—ç¨¿æª¢è¦–ï¼‰

### åŠŸèƒ½èªªæ˜
- é¡¯ç¤ºéŒ„éŸ³æª”è³‡è¨Š
- æ”¯æ´ **ğŸµ æ’­æ”¾** å’Œ **â¬‡ï¸ ä¸‹è¼‰**
- pending ç‹€æ…‹é¡¯ç¤ºã€Œè½‰éŒ„ä¸­...ã€
- å·²è½‰éŒ„é¡¯ç¤ºæ–‡å­—ç¨¿å…§å®¹

### ç¨‹å¼ç¢¼

```php
<?
require_once 'config.php';

$id = $_GET['id'] ?? '';
if (!$id) {
    header('Location: index.php');
    exit;
}

$index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
$files = $index['files'] ?? [];
$file = null;
foreach ($files as $f) {
    if ($f['id'] === $id) {
        $file = $f;
        break;
    }
}

if (!$file) {
    echo 'æ‰¾ä¸åˆ°è©²éŒ„éŸ³æª”';
    exit;
}

$transcriptPath = TRANSCRIPTS_DIR . '/' . $id . '.md';
$hasTranscript = file_exists($transcriptPath);
$transcriptContent = $hasTranscript ? file_get_contents($transcriptPath) : null;

$page = max(1, intval($_GET['page'] ?? 1));
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= htmlspecialchars($file['filename']) ?> - éŒ„éŸ³æª”</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        .file-info { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .file-info h2 { margin: 0 0 10px 0; color: #333; }
        .file-info p { margin: 5px 0; color: #666; }
        .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 14px; }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.done { background: #d4edda; color: #155724; }
        .transcript { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: pre-wrap; line-height: 1.6; }
        .no-transcript { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.php?page=<?= $page ?>" class="back-link">â† è¿”å›åˆ—è¡¨</a>
        
        <div class="file-info">
            <h2><?= htmlspecialchars($file['filename']) ?></h2>
            <p>æ—¥æœŸï¼š<?= htmlspecialchars($file['date']) ?></p>
            <p>é•·åº¦ï¼š<?= round($file['duration'] / 60) ?>:<?= str_pad($file['duration'] % 60, 2, '0', STR_PAD_LEFT) ?></p>
            <p>å¤§å°ï¼š<?= round($file['size'] / 1024) ?> KB</p>
            <p>ç‹€æ…‹ï¼š
                <span class="status <?= $file['status'] ?? 'pending' ?>">
                    <?= ($file['status'] ?? 'pending') === 'done' ? 'å·²å®Œæˆ' : 'è½‰éŒ„ä¸­...' ?>
                </span>
            </p>
            <?php if (!empty($file['backup_path'])): ?>
            <p>
                <a href="<?= htmlspecialchars($file['backup_path']) ?>" target="_blank">ğŸµ æ’­æ”¾</a>
                <a href="<?= htmlspecialchars($file['backup_path']) ?>" download>â¬‡ï¸ ä¸‹è¼‰</a>
            </p>
            <?php endif; ?>
        </div>
        
        <?php if ($hasTranscript): ?>
        <div class="transcript"><?= htmlspecialchars($transcriptContent) ?></div>
        <?php else: ?>
        <div class="transcript no-transcript">
            <p>â³ è½‰éŒ„è™•ç†ä¸­...</p>
            <p style="font-size: 14px; color: #999;">è«‹ç¨å¾Œå†å›ä¾†æŸ¥çœ‹æ–‡å­—ç¨¿</p>
        </div>
        <?php endif; ?>
    </div>
</body>
</html>
```

---

## config.php

```php
<?php
define('DATA_DIR', __DIR__ . '/data');
define('RECORDINGS_DIR', DATA_DIR . '/recordings');
define('TRANSCRIPTS_DIR', DATA_DIR . '/transcripts');
define('INDEX_FILE', DATA_DIR . '/index.json');
define('ITEMS_PER_PAGE', 40);

// OpenAI Whisper API
define('OPENAI_API_KEY', 'sk-...');
define('OPENAI_API_URL', 'https://api.openai.com/v1/audio/transcriptions');
```

---

## è³‡æ–™çµæ§‹

### index.json ç¯„ä¾‹

```json
{
  "files": [
    {
      "id": "1707192940_abc123",
      "filename": "file_11.m4a",
      "path": "recordings/1707192940_abc123.m4a",
      "backup_path": "recordings/1707192940_abc123.m4a",
      "transcript_path": "transcripts/1707192940_abc123.md",
      "date": "2026-02-06 13:35:00",
      "duration": 12,
      "size": 201469,
      "status": "done"
    }
  ]
}
```

### æ¬„ä½èªªæ˜

| æ¬„ä½ | èªªæ˜ |
|------|------|
| `id` | å”¯ä¸€è­˜åˆ¥ç¢¼ (timestamp + md5) |
| `filename` | åŸå§‹æª”å |
| `path` | éŒ„éŸ³æª”ç›¸å°è·¯å¾‘ |
| `backup_path` | æ’­æ”¾/ä¸‹è¼‰è·¯å¾‘ |
| `transcript_path` | æ–‡å­—ç¨¿ç›¸å°è·¯å¾‘ |
| `date` | è™•ç†æ—¥æœŸæ™‚é–“ |
| `duration` | éŒ„éŸ³æ™‚é•· (ç§’) |
| `size` | æª”æ¡ˆå¤§å° (bytes) |
| `status` | ç‹€æ…‹ (pending/done) |

---

## ç’°å¢ƒéœ€æ±‚

| é …ç›® | ç‰ˆæœ¬/éœ€æ±‚ |
|------|-----------|
| NAS | Synology DS218 |
| Web Server | Synology Web Station |
| PHP | 7.x+ (éœ€è¦ cURL) |
| OpenAI API | Whisper-1 æ¨¡å‹ |
| OpenClaw | æœ€æ–°ç‰ˆæœ¬ |
| Whisper | æœ¬æ©Ÿéƒ¨ç½² (/phonetts ç”¨) |

---

## è²»ç”¨

| æœå‹™ | è²»ç”¨ |
|------|------|
| Web ä¸Šå‚³ (OpenAI API) | $0.006/åˆ†é˜ |
| Telegram (/phonetts) | **å…è²»** (æœ¬æ©Ÿ Whisper) |

---

## æ›´æ–°æ—¥èªŒ

### v5 (2026-02-06)
- **é›™è»Œç³»çµ±**ï¼šTelegram (/phonetts) + Web ä¸Šå‚³ (upload.php)
- **upload.php æ›´æ–°**ï¼š
  - è‡ªå‹•èª¿ç”¨ OpenAI Whisper API è½‰éŒ„
  - æ–°å¢ `backup_path` æ”¯æ´æ’­æ”¾/ä¸‹è¼‰
  - æ–°å¢ **25MB æª”æ¡ˆå¤§å°é™åˆ¶**
  - å‰ç«¯å³æ™‚æª¢æŸ¥æª”æ¡ˆå¤§å°
- **index.php æ›´æ–°**ï¼š
  - æª”åæ°¸é é¡¯ç¤ºè¶…é€£çµ
  - pending æª”æ¡ˆé¡¯ç¤º `(å¾…è½‰éŒ„)` æ¨™ç±¤
- **view.php æ›´æ–°**ï¼š
  - pending ç‹€æ…‹é¡¯ç¤ºã€Œè½‰éŒ„ä¸­...ã€
  - æ”¯æ´æ’­æ”¾/ä¸‹è¼‰æŒ‰éˆ•

### v4 (2026-02-06)
- ç§»é™¤ï¼šindex.php çš„ã€Œç‹€æ…‹ã€æ¬„ä½
- æ›´æ–°ï¼šæµç¨‹èªªæ˜ï¼ˆ5 æ­¥é©Ÿæµç¨‹ï¼‰
- æ›´æ–°ï¼šindex.php ç¨‹å¼ç¢¼

### v3 (2026-02-06)
- æŠ€èƒ½åç¨±è®Šæ›´ï¼š`#ttsphone` â†’ `/phonetts`
- æ–°å¢ï¼šä½¿ç”¨ç¨ç«‹ç›®éŒ„ `temp/telegram-file/`
- æ–°å¢ï¼šå®Œæ•´çš„è™•ç†æµç¨‹æ–‡ä»¶
- æ”¹å–„ï¼šè‡ªå‹•æ¸…ç†æœ¬æ©Ÿ telegram-file/ ç›®éŒ„

### v2 (2026-02-06)
- æ–°å¢ï¼šéŒ„éŸ³æª”å‚™ä»½åˆ° NAS `backups/` ç›®éŒ„
- æ–°å¢ï¼šview.php æ’­æ”¾/ä¸‹è¼‰æŒ‰éˆ•
- æ–°å¢ï¼š`backup_path` æ¬„ä½è¨˜éŒ„å‚™ä»½æª”ä½ç½®
- æ”¹å–„ï¼šè½‰éŒ„å¾Œåˆªé™¤æœ¬æ©ŸéŒ„éŸ³æª”

### v1 (2024-02-06)
- åˆå§‹ç‰ˆæœ¬
- iPhone æ·å¾‘ä¸Šå‚³æ–¹å¼
- OpenAI Whisper API è½‰æ–‡å­—
