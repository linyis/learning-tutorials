# éŒ„éŸ³ç¨‹å¼ç³»çµ± (Voice Recording System)

## ä¸Šå‚³æ–¹å¼

### æ–¹å¼ä¸€ï¼šiPhone æ·å¾‘

```
iPhone æ·å¾‘ â†’ [POST ä¸Šå‚³] â†’ NAS PHP ç¨‹å¼ â†’ [OpenAI Whisper API] â†’ æ–‡å­—ç¨¿(.md)
                                    â†“
                              [index.json] ç´¢å¼•
```

### æ–¹å¼äºŒï¼šTelegram å‚³é€éŒ„éŸ³æª” (/phonetts)

```
Telegram å‚³é€éŒ„éŸ³æª” â†’ OpenClaw æ¥æ”¶ â†’ [Whisper æœ¬æ©Ÿè½‰æ–‡å­—] â†’ åŒæ­¥åˆ° NAS
                                        â†“
                              [index.json + .md + backups/ è‡ªå‹•æ›´æ–°]
```

---

## /phonetts æœ¬æ©Ÿç¨‹å¼ (OpenClaw Skill)

### åŠŸèƒ½èªªæ˜
- æ¥æ”¶ Telegram éŒ„éŸ³æª” (m4a/mp3)
- ä½¿ç”¨ Whisper æœ¬æ©Ÿè½‰æ–‡å­—
- ç”¢ç”Ÿ `.md` æ–‡å­—ç¨¿
- æ›´æ–° `index.json` ç´¢å¼•
- éŒ„éŸ³æª”å‚™ä»½åˆ° NAS `backups/` ç›®éŒ„
- åˆªé™¤æœ¬æ©Ÿå¿«å–ï¼Œé¿å…é‡è¤‡è™•ç†
- **ä½¿ç”¨ç¨ç«‹ç›®éŒ„ `telegram-file/`**ï¼Œèˆ‡ youtube-video-summary å€åˆ†

### è§¸ç™¼æ–¹å¼
- **æŒ‡ä»¤**: `/phonetts` æˆ–ç›´æ¥å‚³é€éŒ„éŸ³æª”

### å·¥ä½œæµç¨‹

```
1. /phonetts
2. å›è¦†ã€Œè«‹å‚³è¼¸éŒ„éŸ³æª”ã€
3. ç”¨æˆ¶å‚³é€éŒ„éŸ³æª”
4. å›è¦†ã€Œè™•ç†éŒ„éŸ³ä¸­...ã€
5. å®Œæˆå¾Œå›å ±çµæœ
```

```
Telegram â†’ media/inbound/
              â†“
         temp/telegram-file/recording.m4a  (ç¨ç«‹ç›®éŒ„)
              â†“
         FFmpeg è½‰æ›æ ¼å¼ â†’ audio.wav
              â†“
         Whisper è½‰æ–‡å­— â†’ transcript.json
              â†“
         ç”¢ç”Ÿ .md æª”æ¡ˆ â†’ temp/data/transcripts/{id}.md
              â†“
         æ›´æ–° index.json
              â†“
         è¤‡è£½éŒ„éŸ³åˆ° NAS backups/{filename}_{timestamp}.m4a
              â†“
         åŒæ­¥ md + json åˆ° NAS voice-sync/data/
              â†“
         åˆªé™¤ temp/telegram-file/ (æœ¬æ©Ÿæ¸…ç†)
```

### æœ¬æ©Ÿç›®éŒ„çµæ§‹
```
C:\Users\linyi\.openclaw\workspace\
â”œâ”€â”€ temp/
â”‚   â”œâ”€â”€ telegram-file/           # Telegram éŒ„éŸ³æª”ï¼ˆç¨ç«‹ç›®éŒ„ï¼‰
â”‚   â”‚   â”œâ”€â”€ recording.m4a      # è‡¨æ™‚éŒ„éŸ³æª”
â”‚   â”‚   â”œâ”€â”€ audio.wav            # FFmpeg è½‰æ›å¾Œ
â”‚   â”‚   â””â”€â”€ transcript.json      # Whisper è¼¸å‡º
â”‚   â””â”€â”€ data/
â”‚       â”œâ”€â”€ index.json          # ç´¢å¼•è³‡æ–™åº«
â”‚       â””â”€â”€ transcripts/        # æ–‡å­—ç¨¿
â”‚           â””â”€â”€ {id}.md
â”œâ”€â”€ transcribe.py                 # Whisper è½‰æ–‡å­—
â””â”€â”€ skills/phonetts/           # Skill æª”æ¡ˆ
```

### èˆ‡ youtube-video-summary å€åˆ†

| åŠŸèƒ½ | ç›®éŒ„ |
|------|------|
| /phonetts | `temp/telegram-file/` |
| /youtube-video-summary | `temp/*.m4a, *.wav` |

---

## Python ç¨‹å¼ç¢¼

### transcribe.py - Whisper æœ¬æ©Ÿè½‰æ–‡å­—

```python
import os
import sys
import whisper

# FFmpeg è·¯å¾‘
ffmpeg_path = r'C:\Users\linyi\AppData\Local\Microsoft\WinGet\Packages\Gyan.FFmpeg_Microsoft.Winget.Source_8wekyb3d8bbwe\ffmpeg-8.0.1-full_build\bin'
os.environ['PATH'] = ffmpeg_path + os.pathsep + os.environ['PATH']

# UTF-8 è¼¸å‡º
sys.stdout.reconfigure(encoding='utf-8', errors='replace')

# Whisper è½‰æ–‡å­—
model = whisper.load_model('base')
result = model.transcribe('temp/telegram-file/audio.wav', language='Chinese')

# ä¿å­˜çµæœ
import json
with open('temp/telegram-file/transcript.json', 'w', encoding='utf-8') as f:
    json.dump(result, f, ensure_ascii=False, indent=2)

# æ‰“å°è½‰éŒ„æ–‡å­—
for segment in result['segments']:
    print(f"[{segment['start']:.2f} - {segment['end']:.2f}] {segment['text']}")
```

### process_phonetts.py - ä¸»è™•ç†è…³æœ¬

```python
import os
import json
import shutil
import subprocess
from datetime import datetime

TELEGRAM_DIR = 'C:\\Users\\linyi\\.openclaw\\workspace\\temp\\telegram-file'
DATA_DIR = 'C:\\Users\\linyi\\.openclaw\\workspace\\temp\\data'
NAS_VOICE_SYNC = '\\\\192.168.1.13\\web\\voice-sync'
NAS_BACKUPS = f'{NAS_VOICE_SYNC}\\backups'

def process_recording(audio_path, original_filename):
    # 1. FFmpeg è½‰æ›æ ¼å¼
    wav_path = os.path.join(TELEGRAM_DIR, 'audio.wav')
    subprocess.run([
        'ffmpeg', '-i', audio_path, '-ar', '16000', '-ac', '1', wav_path, '-y'
    ], capture_output=True)

    # 2. Whisper è½‰æ–‡å­—
    subprocess.run(['python', 'transcribe.py'], cwd=TELEGRAM_DIR)

    # 3. è®€å–è½‰éŒ„çµæœ
    with open(f'{TELEGRAM_DIR}\\transcript.json', 'r', encoding='utf-8') as f:
        transcript_data = json.load(f)

    # 4. ç”Ÿæˆæª”æ¡ˆ ID
    timestamp = int(datetime.now().timestamp())
    file_id = f'{timestamp}'

    # 5. ç”¢ç”Ÿ .md æ–‡å­—ç¨¿
    md_content = f"""# {datetime.now().strftime('%Y-%m-%d')} éŒ„éŸ³è½‰æ–‡å­—ç¨¿

## æª”æ¡ˆè³‡è¨Š
- **æ—¥æœŸ**: {datetime.now().strftime('%Y-%m-%d %H:%M')}
- **ä¾†æº**: {original_filename}

---

## è½‰éŒ„å…§å®¹

{transcript_data['text']}

---

*è½‰éŒ„æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M')}*
*è½‰éŒ„å·¥å…·: OpenAI Whisper (æœ¬åœ°éƒ¨ç½²)*
"""

    md_path = f'{DATA_DIR}\\transcripts\\{file_id}.md'
    with open(md_path, 'w', encoding='utf-8') as f:
        f.write(md_content)

    # 6. æ›´æ–° index.json
    index_path = f'{DATA_DIR}\\index.json'
    if os.path.exists(index_path):
        with open(index_path, 'r', encoding='utf-8') as f:
            index = json.load(f)
    else:
        index = {'files': []}

    # éŒ„éŸ³æª”å‚™ä»½å‘½å
    backup_name = f"{os.path.splitext(original_filename)[0]}_{datetime.now().strftime('%Y%m%d_%H%M')}.m4a"

    index['files'].append({
        'id': file_id,
        'filename': original_filename,
        'path': f'recordings/{file_id}.m4a',
        'backup_path': f'backups/{backup_name}',
        'transcript_path': f'transcripts/{file_id}.md',
        'date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'duration': 0,
        'size': os.path.getsize(audio_path),
        'status': 'done'
    })

    with open(index_path, 'w', encoding='utf-8') as f:
        json.dump(index, f, ensure_ascii=False, indent=2)

    # 7. è¤‡è£½éŒ„éŸ³åˆ° NAS backups/
    nas_backup_path = f'{NAS_BACKUPS}\\{backup_name}'
    shutil.copy2(audio_path, nas_backup_path)

    # 8. åŒæ­¥åˆ° NAS
    shutil.copy(md_path, f'{NAS_VOICE_SYNC}\\data\\transcripts\\')
    shutil.copy(index_path, f'{NAS_VOICE_SYNC}\\data\\')

    # 9. åˆªé™¤æœ¬æ©Ÿ telegram-file/ ç›®éŒ„
    shutil.rmtree(TELEGRAM_DIR)
    os.makedirs(TELEGRAM_DIR, exist_ok=True)

    print(f'å®Œæˆï¼éŒ„éŸ³å·²åŒæ­¥åˆ° NAS backups/')
```

---

## ç’°å¢ƒéœ€æ±‚

| é …ç›® | ç‰ˆæœ¬/éœ€æ±‚ |
|------|-----------|
| NAS | Synology DS218j (DSM 6.2.4) |
| Web Server | Synology Web Station |
| PHP | 7.x+ |
| OpenClaw | æœ€æ–°ç‰ˆæœ¬ |
| Whisper | æœ¬æ©Ÿéƒ¨ç½² (OpenAI Whisper) |
| FFmpeg | å¿…è¦å…ƒä»¶ |

---

## ç›®éŒ„çµæ§‹

### NAS ç«¯
```
/web/voice-sync/
â”œâ”€â”€ index.php          # æª”æ¡ˆåˆ—è¡¨ï¼ˆç„¡ç‹€æ…‹æ¬„ä½ï¼‰
â”œâ”€â”€ view.php           # æ–‡å­—ç¨¿æª¢è¦– + æ’­æ”¾/ä¸‹è¼‰æŒ‰éˆ•
â”œâ”€â”€ api.php            # æœå°‹ API
â”œâ”€â”€ config.php         # è¨­å®šæª”
â”œâ”€â”€ backups/           # éŒ„éŸ³æª”å‚™ä»½å€
â””â”€â”€ data/
    â”œâ”€â”€ index.json     # ç´¢å¼•è³‡æ–™åº«
    â””â”€â”€ transcripts/   # èªéŸ³è½‰æ–‡å­— (.md)
```

### æœ¬æ©Ÿç«¯ (OpenClaw)
```
C:\Users\linyi\.openclaw\workspace\
â”œâ”€â”€ temp/
â”‚   â”œâ”€â”€ telegram-file/           # Telegram éŒ„éŸ³æª”ï¼ˆç¨ç«‹ç›®éŒ„ï¼‰
â”‚   â”‚   â”œâ”€â”€ recording.m4a       # è‡¨æ™‚éŒ„éŸ³æª”
â”‚   â”‚   â”œâ”€â”€ audio.wav           # FFmpeg è½‰æ›å¾Œ
â”‚   â”‚   â””â”€â”€ transcript.json     # Whisper è¼¸å‡º
â”‚   â””â”€â”€ data/
â”‚       â”œâ”€â”€ index.json          # ç´¢å¼•è³‡æ–™åº«
â”‚       â””â”€â”€ transcripts/       # æ–‡å­—ç¨¿
â”‚           â””â”€â”€ {id}.md
â”œâ”€â”€ transcribe.py               # Whisper è½‰æ–‡å­—
â”œâ”€â”€ process_phonetts.py         # ä¸»è™•ç†è…³æœ¬
â””â”€â”€ skills/
    â””â”€â”€ phonetts/
        â””â”€â”€ SKILL.md           # Skill æ–‡ä»¶
```

---

## ç¨‹å¼ç¢¼

### 1. config.php

```php
<?php
define('DATA_DIR', __DIR__ . '/data');
define('RECORDINGS_DIR', DATA_DIR . '/recordings');
define('TRANSCRIPTS_DIR', DATA_DIR . '/transcripts');
define('INDEX_FILE', DATA_DIR . '/index.json');
define('ITEMS_PER_PAGE', 40);
```

### 2. index.phpï¼ˆæª”æ¡ˆåˆ—è¡¨ - ç„¡ç‹€æ…‹æ¬„ä½ï¼‰

```php
<?
require_once 'config.php';

$index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
$files = $index['files'] ?? [];

usort($files, function($a, $b) {
    return strtotime($b['date']) - strtotime($a['date']);
});

$page = max(1, intval($_GET['page'] ?? 1));
$totalPages = ceil(count($files) / ITEMS_PER_PAGE);
$start = ($page - 1) * ITEMS_PER_PAGE;
$pageFiles = array_slice($files, $start, $ITEMS_PER_PAGE);

function formatDuration($seconds) {
    $m = floor($seconds / 60);
    $s = $seconds % 60;
    return sprintf('%d:%02d', $m, $s);
}
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŒ„éŸ³æª”åˆ—è¡¨</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { color: #333; }
        .search { margin: 20px 0; }
        .search input { padding: 10px; width: 300px; border: 1px solid #ddd; border-radius: 4px; }
        .search button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; }
        tr:hover { background: #f8f9fa; }
        .duration { color: #666; }
        .pagination { margin: 20px 0; display: flex; gap: 5px; }
        .pagination a { padding: 8px 12px; background: white; border: 1px solid #ddd; text-decoration: none; color: #333; border-radius: 4px; }
        .pagination a.active { background: #007bff; color: white; border-color: #007bff; }
        .filename { color: #007bff; text-decoration: none; }
        .filename:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>éŒ„éŸ³æª”åˆ—è¡¨</h1>
        
        <div class="search">
            <form method="GET" action="api.php">
                <input type="text" name="q" placeholder="æœå°‹éŒ„éŸ³å…§å®¹...">
                <button type="submit">æœå°‹</button>
            </form>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>æª”å</th>
                    <th>é•·åº¦</th>
                    <th>å¤§å°</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($pageFiles as $file): ?>
                <tr>
                    <td><?= htmlspecialchars($file['date']) ?></td>
                    <td>
                        <a href="view.php?id=<?= urlencode($file['id']) ?>" class="filename">
                            <?= htmlspecialchars($file['filename']) ?>
                        </a>
                    </td>
                    <td class="duration"><?= formatDuration($file['duration']) ?></td>
                    <td><?= round($file['size'] / 1024) ?> KB</td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
        
        <div class="pagination">
            <?php for ($i = 1; $i <= $totalPages; $i++): ?>
                <a href="?page=<?= $i ?>" class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
            <?php endfor; ?>
        </div>
    </div>
</body>
</html>
```

### 2.5. upload.phpï¼ˆiOS å‹å–„ä¸Šå‚³ä»‹é¢ï¼‰

```php
<?
require_once 'config.php';

// å»ºç«‹è³‡æ–™å¤¾
if (!is_dir(RECORDINGS_DIR)) mkdir(RECORDINGS_DIR, 0755, true);
if (!is_dir(TRANSCRIPTS_DIR)) mkdir(TRANSCRIPTS_DIR, 0755, true);

// è™•ç†ä¸Šå‚³
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['audio'])) {
    $file = $_FILES['audio'];
    $originalName = basename($file['name']);
    $fileId = time() . '_' . substr(md5($originalName), 0, 8);
    $extension = strtolower(pathinfo($originalName, PATHINFO_EXTENSION)) ?: 'm4a';
    
    $recordingsPath = RECORDINGS_DIR . '/' . $fileId . '.' . $extension;
    
    if (move_uploaded_file($file['tmp_name'], $recordingsPath)) {
        // æ›´æ–° index.json
        $index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
        $index['files'][] = [
            'id' => $fileId,
            'filename' => $originalName,
            'path' => 'recordings/' . $fileId . '.' . $extension,
            'transcript_path' => 'transcripts/' . $fileId . '.md',
            'date' => date('Y-m-d H:i:s'),
            'duration' => 0,
            'size' => filesize($recordingsPath),
            'status' => 'pending'
        ];
        file_put_contents(INDEX_FILE, json_encode($index, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
        
        echo json_encode(['success' => true, 'id' => $fileId, 'message' => 'ä¸Šå‚³æˆåŠŸï¼Œè½‰éŒ„ä¸­...']);
    } else {
        echo json_encode(['success' => false, 'message' => 'ä¸Šå‚³å¤±æ•—']);
    }
    exit;
}
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šå‚³éŒ„éŸ³</title>
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            margin: 0; padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
        }
        .container { 
            background: white; padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px; width: 100%; text-align: center;
        }
        h1 { color: #333; margin-bottom: 30px; }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        .upload-area:hover { border-color: #764ba2; background: #f0f0ff; }
        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        .upload-text { color: #666; margin-bottom: 10px; }
        .upload-hint { font-size: 12px; color: #999; }
        input[type="file"] { display: none; }
        .btn {
            display: inline-block;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none;
            border-radius: 30px;
            font-size: 16px; cursor: pointer;
            margin: 5px;
        }
        .recording-btn {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: #dc3545; border: none;
            color: white; font-size: 14px;
            cursor: pointer; margin: 10px;
        }
        .recording-btn.recording {
            background: #dc3545;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .result { margin-top: 20px; padding: 15px; border-radius: 10px; display: none; }
        .result.success { background: #d4edda; color: #155724; display: block; }
        .result.error { background: #f8d7da; color: #721c24; display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ ä¸Šå‚³éŒ„éŸ³</h1>
        
        <!-- é¸æ“‡æª”æ¡ˆ -->
        <div class="upload-area" onclick="document.getElementById('audioInput').click()">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">é»æ“Šé¸æ“‡éŒ„éŸ³æª”</div>
            <div class="upload-hint">æ”¯æ´ M4Aã€MP3ã€WAV æ ¼å¼</div>
        </div>
        <input type="file" id="audioInput" accept="audio/*,.m4a,.mp3,.wav" onchange="uploadFile(this)">
        
        <div style="margin: 20px 0; color: #999;">â€” æˆ– â€”</div>
        
        <!-- ç›´æ¥éŒ„éŸ³ (iOS) -->
        <button class="recording-btn" id="recordBtn" onmousedown="startRecording()" ontouchstart="startRecording(event)" onmouseup="stopRecording()" ontouchend="stopRecording(event)">
            ğŸ™<br>é•·æŒ‰éŒ„éŸ³
        </button>
        <div id="recordingStatus" style="font-size: 12px; color: #666;"></div>
        
        <div id="result" class="result"></div>
    </div>
    
    <script>
        // é¸æ“‡æª”æ¡ˆä¸Šå‚³
        function uploadFile(input) {
            if (input.files.length > 0) {
                const file = input.files[0];
                const formData = new FormData();
                formData.append('audio', file);
                
                input.disabled = true;
                document.getElementById('result').className = 'result';
                document.getElementById('result').innerHTML = 'ä¸Šå‚³ä¸­...';
                document.getElementById('result').style.display = 'block';
                
                fetch('upload.php', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    input.disabled = false;
                    if (data.success) {
                        document.getElementById('result').className = 'result success';
                        document.getElementById('result').innerHTML = 'âœ… ' + data.message;
                        setTimeout(() => window.location.href = 'index.php', 2000);
                    } else {
                        document.getElementById('result').className = 'result error';
                        document.getElementById('result').innerHTML = 'âŒ ' + data.message;
                    }
                });
            }
        }
        
        // éŒ„éŸ³åŠŸèƒ½
        let mediaRecorder = null;
        let audioChunks = [];
        
        function startRecording(e) {
            if (e) e.preventDefault();
            navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = ev => audioChunks.push(ev.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/m4a' });
                    const file = new File([audioBlob], 'éŒ„éŸ³_' + Date.now() + '.m4a', { type: 'audio/m4a' });
                    const formData = new FormData();
                    formData.append('audio', file);
                    document.getElementById('recordingStatus').innerHTML = 'è™•ç†ä¸­...';
                    fetch('upload.php', { method: 'POST', body: formData })
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById('recordingStatus').innerHTML = '';
                        document.getElementById('result').className = data.success ? 'result success' : 'result error';
                        document.getElementById('result').innerHTML = data.success ? 'âœ… ' + data.message : 'âŒ ' + data.message;
                        if (data.success) setTimeout(() => window.location.href = 'index.php', 2000);
                        stream.getTracks().forEach(t => t.stop());
                    });
                };
                mediaRecorder.start();
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordingStatus').innerHTML = 'éŒ„éŸ³ä¸­... è«‹èªªè©±';
            })
            .catch(() => {
                document.getElementById('recordingStatus').innerHTML = 'âš ï¸ ç„¡æ³•è¨ªå•éº¥å…‹é¢¨';
            });
        }
        
        function stopRecording(e) {
            if (e) e.preventDefault();
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('recordBtn').classList.remove('recording');
            }
        }
    </script>
</body>
</html>
```

### 3. view.phpï¼ˆæ–‡å­—ç¨¿æª¢è¦– + æ’­æ”¾/ä¸‹è¼‰ï¼‰

```php
<?
require_once 'config.php';

$id = $_GET['id'] ?? '';
if (!$id) {
    header('Location: index.php');
    exit;
}

// å–å¾—éŒ„éŸ³æª”è³‡è¨Š
$index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
$files = $index['files'] ?? [];
$file = null;
foreach ($files as $f) {
    if ($f['id'] === $id) {
        $file = $f;
        break;
    }
}

if (!$file) {
    echo 'æ‰¾ä¸åˆ°è©²éŒ„éŸ³æª”';
    exit;
}

// è®€å–æ–‡å­—ç¨¿
$transcriptPath = TRANSCRIPTS_DIR . '/' . $id . '.md';
$transcriptContent = file_exists($transcriptPath) ? file_get_contents($transcriptPath) : 'è½‰éŒ„ä¸­...';

$page = max(1, intval($_GET['page'] ?? 1));
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= htmlspecialchars($file['filename']) ?> - æ–‡å­—ç¨¿</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
        .file-info { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .file-info h2 { margin: 0 0 10px 0; color: #333; }
        .file-info p { margin: 5px 0; color: #666; }
        .file-info a { margin-right: 15px; text-decoration: none; }
        .file-info a:hover { text-decoration: underline; }
        .transcript { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: pre-wrap; line-height: 1.6; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.php?page=<?= $page ?>" class="back-link">â† è¿”å›åˆ—è¡¨</a>

        <div class="file-info">
            <h2><?= htmlspecialchars($file['filename']) ?></h2>
            <p>æ—¥æœŸï¼š<?= htmlspecialchars($file['date']) ?></p>
            <p>é•·åº¦ï¼š<?= round($file['duration'] / 60) ?>:<?= str_pad($file['duration'] % 60, 2, '0', STR_PAD_LEFT) ?></p>
            <?php if (!empty($file['backup_path'])): ?>
            <p>
                <a href="<?= htmlspecialchars($file['backup_path']) ?>" target="_blank">ğŸµ æ’­æ”¾</a>
                <a href="<?= htmlspecialchars($file['backup_path']) ?>" download>â¬‡ï¸ ä¸‹è¼‰</a>
            </p>
            <?php endif; ?>
        </div>

        <div class="transcript"><?= htmlspecialchars($transcriptContent) ?></div>
    </div>
</body>
</html>
```

### 4. api.phpï¼ˆæœå°‹ï¼‰

```php
<?php
require_once 'config.php';

$index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
$files = $index['files'] ?? [];

$query = trim($_GET['q'] ?? '');

if ($query) {
    $results = [];
    foreach ($files as $file) {
        $transcriptPath = TRANSCRIPTS_DIR . '/' . $file['id'] . '.md';
        if (file_exists($transcriptPath)) {
            $content = file_get_contents($transcriptPath);
            if (stripos($content, $query) !== false) {
                $results[] = [
                    'file' => $file,
                    'preview' => mb_substr($content, 0, 200) . '...'
                ];
            }
        }
    }
    header('Content-Type: application/json; charset=UTF-8');
    echo json_encode(['results' => $results, 'count' => count($results)], JSON_UNESCAPED_UNICODE);
}
```

---

## è³‡æ–™çµæ§‹

### index.json ç¯„ä¾‹

```json
{
  "files": [
    {
      "id": "1707192940_y67890",
      "filename": "file_11.m4a",
      "path": "recordings/1707192940_y67890.m4a",
      "backup_path": "backups/file_11_20260206_1335.m4a",
      "transcript_path": "transcripts/1707192940_y67890.md",
      "date": "2026-02-06 13:35:00",
      "duration": 12,
      "size": 201469,
      "status": "done"
    }
  ]
}
```

### æ¬„ä½èªªæ˜

| æ¬„ä½ | èªªæ˜ |
|------|------|
| `id` | å”¯ä¸€è­˜åˆ¥ç¢¼ (timestamp) |
| `filename` | åŸå§‹æª”å |
| `path` | éŒ„éŸ³æª”ç›¸å°è·¯å¾‘ |
| `backup_path` | å‚™ä»½æª”ç›¸å°è·¯å¾‘ (backups/{original}_{timestamp}.m4a) |
| `transcript_path` | æ–‡å­—ç¨¿ç›¸å°è·¯å¾‘ |
| `date` | è™•ç†æ—¥æœŸæ™‚é–“ |
| `duration` | éŒ„éŸ³æ™‚é•· (ç§’) |
| `size` | æª”æ¡ˆå¤§å° (bytes) |
| `status` | ç‹€æ…‹ (pending/done) |

---

## éƒ¨ç½²æ­¥é©Ÿ

### NAS SSH æŒ‡ä»¤

```bash
# 1. å»ºç«‹ç›®éŒ„
sudo mkdir -p /web/voice-sync/data/{recordings,transcripts}
sudo mkdir -p /web/voice-sync/backups
sudo chown -R http:http /web/voice-sync

# 2. ä¸Šå‚³ç¨‹å¼ç¢¼
# ä½¿ç”¨ File Station æˆ– SCP ä¸Šå‚³æ‰€æœ‰æª”æ¡ˆåˆ° /web/voice-sync/

# 3. è¨­å®šæ¬Šé™
chmod -R 755 /web/voice-sync
```

### æœ¬æ©Ÿ OpenClaw è¨­å®š

```bash
# 1. å®‰è£ä¾è³´
pip install openai-whisper

# 2. FFmpeg è·¯å¾‘
# C:\Users\linyi\AppData\Local\Microsoft\WinGet\Packages\Gyan.FFmpeg_Microsoft.Winget.Source_8wekyb3d8bbwe\ffmpeg-8.0.1-full_build\bin
```

---

## è²»ç”¨

| æœå‹™ | è²»ç”¨ |
|------|------|
| OpenAI Whisper API | $0.006/åˆ†é˜ (åƒ… iPhone æ·å¾‘æ–¹å¼) |
| /phonetts (æœ¬æ©Ÿ) | **å…è²»** (Whisper æœ¬æ©Ÿéƒ¨ç½²) |

---

## æ›´æ–°æ—¥èªŒ

### v4 (2026-02-06)
- ç§»é™¤ï¼šindex.php çš„ã€Œç‹€æ…‹ã€æ¬„ä½
- æ›´æ–°ï¼šæµç¨‹èªªæ˜ï¼ˆ5 æ­¥é©Ÿæµç¨‹ï¼‰
- æ›´æ–°ï¼šindex.php ç¨‹å¼ç¢¼

### v3 (2026-02-06)
- æŠ€èƒ½åç¨±è®Šæ›´ï¼š`#ttsphone` â†’ `/phonetts`
- æ–°å¢ï¼šä½¿ç”¨ç¨ç«‹ç›®éŒ„ `temp/telegram-file/`
- æ–°å¢ï¼šå®Œæ•´çš„è™•ç†æµç¨‹æ–‡ä»¶
- æ”¹å–„ï¼šè‡ªå‹•æ¸…ç†æœ¬æ©Ÿ telegram-file/ ç›®éŒ„

### v2 (2026-02-06)
- æ–°å¢ï¼šéŒ„éŸ³æª”å‚™ä»½åˆ° NAS `backups/` ç›®éŒ„
- æ–°å¢ï¼šview.php æ’­æ”¾/ä¸‹è¼‰æŒ‰éˆ•
- æ–°å¢ï¼š`backup_path` æ¬„ä½è¨˜éŒ„å‚™ä»½æª”ä½ç½®
- æ”¹å–„ï¼šè½‰éŒ„å¾Œåˆªé™¤æœ¬æ©ŸéŒ„éŸ³æª”

### v1 (2024-02-06)
- åˆå§‹ç‰ˆæœ¬
- iPhone æ·å¾‘ä¸Šå‚³æ–¹å¼
- OpenAI Whisper API è½‰æ–‡å­—
