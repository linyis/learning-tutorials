# 錄音程式系統 (Voice Recording System)

## 概述

從 iPhone 捷徑上傳錄音檔到 Synology NAS，自動轉文字並建立索引。

```
iPhone 捷徑 → [POST 上傳] → NAS PHP 程式 → [OpenAI Whisper API] → 文字稿(.md)
                                    ↓
                              [index.json] 索引
```

## 環境需求

| 項目 | 版本/需求 |
|------|-----------|
| NAS | Synology DS218j (DSM 6.2.4) |
| Web Server | Synology Web Station |
| PHP | 7.x+ |
| API | OpenAI Whisper API ($0.006/分鐘) |

## 目錄結構

```
/web/voice-sync/
├── index.php          # 檔案列表 + 分頁
├── upload.php         # 接收上傳 + API 轉文字
├── api.php            # 搜尋 API
├── config.php         # 設定檔（API Key）
└── data/
    ├── recordings/   # 錄音檔 (.m4a, .mp3)
    ├── transcripts/   # 語音轉文字 (.md)
    └── index.json     # 索引資料庫
```

## 程式碼

### 1. config.php

```php
<?php
define('DATA_DIR', __DIR__ . '/data');
define('RECORDINGS_DIR', DATA_DIR . '/recordings');
define('TRANSCRIPTS_DIR', DATA_DIR . '/transcripts');
define('INDEX_FILE', DATA_DIR . '/index.json');
define('ITEMS_PER_PAGE', 40);

// OpenAI Whisper API
define('OPENAI_API_KEY', 'YOUR_OPENAI_API_KEY');
define('OPENAI_API_URL', 'https://api.openai.com/v1/audio/transcriptions');
```

### 2. index.php（檔案列表 + 分頁）

```php
<?php
require_once 'config.php';

$index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
$files = $index['files'] ?? [];

// 日期新到舊排序
usort($files, function($a, $b) {
    return strtotime($b['date']) - strtotime($a['date']);
});

// 分頁（每頁 40 筆）
$page = max(1, intval($_GET['page'] ?? 1));
$totalPages = ceil(count($files) / ITEMS_PER_PAGE);
$start = ($page - 1) * ITEMS_PER_PAGE;
$pageFiles = array_slice($files, $start, ITEMS_PER_PAGE);

function formatDuration($seconds) {
    $m = floor($seconds / 60);
    $s = $seconds % 60;
    return sprintf('%d:%02d', $m, $s);
}
?>
<!-- HTML 表格顯示檔案列表 -->
```

### 3. upload.php（上傳 + 背景轉文字）

```php
<?php
require_once 'config.php';

// 建立資料夾
if (!is_dir(RECORDINGS_DIR)) mkdir(RECORDINGS_DIR, 0755, true);
if (!is_dir(TRANSCRIPTS_DIR)) mkdir(TRANSCRIPTS_DIR, 0755, true);

// 處理上傳
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['audio'])) {
    $file = $_FILES['audio'];
    $originalName = basename($file['name']);
    $fileId = time() . '_' . substr(md5($originalName), 0, 8);
    $extension = strtolower(pathinfo($originalName, PATHINFO_EXTENSION)) ?: 'm4a';
    
    $recordingsPath = RECORDINGS_DIR . '/' . $fileId . '.' . $extension;
    $transcriptPath = TRANSCRIPTS_DIR . '/' . $fileId . '.md';
    
    if (move_uploaded_file($file['tmp_name'], $recordingsPath)) {
        // 更新 index.json
        $index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
        $index['files'][] = [
            'id' => $fileId,
            'filename' => $originalName,
            'path' => 'recordings/' . $fileId . '.' . $extension,
            'transcript_path' => 'transcripts/' . $fileId . '.md',
            'date' => date('Y-m-d H:i:s'),
            'duration' => 0,
            'size' => filesize($recordingsPath),
            'status' => 'pending'
        ];
        file_put_contents(INDEX_FILE, json_encode($index, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
        
        // 背景執行 Whisper API
        $scriptPath = DATA_DIR . '/transcribe_' . $fileId . '.php';
        $script = '<?php
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, "' . OPENAI_API_URL . '");
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, ["Authorization: Bearer ' . OPENAI_API_KEY . '"]);
curl_setopt($ch, CURLOPT_POSTFIELDS, [
    "file" => new CURLFile("' . $recordingsPath . '", "audio/mpeg", "' . $originalName . '"),
    "model" => "whisper-1",
    "language" => "zh"
]);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$response = curl_exec($ch);
curl_close($ch);
$result = json_decode($response, true);
if (isset($result["text"])) {
    file_put_contents("' . $transcriptPath . '", $result["text"]);
}
unlink(__FILE__);
';
        file_put_contents($scriptPath, $script);
        exec("nohup php $scriptPath > /dev/null 2>&1 &");
        
        echo json_encode(['success' => true, 'id' => $fileId, 'message' => '上傳成功，轉錄中...']);
    }
}
```

### 4. api.php（搜尋）

```php
<?php
require_once 'config.php';

$index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
$files = $index['files'] ?? [];

$query = trim($_GET['q'] ?? '');

if ($query) {
    $results = [];
    foreach ($files as $file) {
        $transcriptPath = TRANSCRIPTS_DIR . '/' . $file['id'] . '.md';
        if (file_exists($transcriptPath)) {
            $content = file_get_contents($transcriptPath);
            if (stripos($content, $query) !== false) {
                $results[] = [
                    'file' => $file,
                    'preview' => mb_substr($content, 0, 200) . '...'
                ];
            }
        }
    }
    header('Content-Type: application/json; charset=UTF-8');
    echo json_encode(['results' => $results, 'count' => count($results)], JSON_UNESCAPED_UNICODE);
}
```

## 資料結構

### index.json 範例

```json
{
  "files": [
    {
      "id": "1707187200_abc123",
      "filename": "錄音.m4a",
      "path": "recordings/1707187200_abc123.m4a",
      "transcript_path": "transcripts/1707187200_abc123.md",
      "date": "2024-02-06 00:00:00",
      "duration": 0,
      "size": 1024000,
      "status": "done"
    }
  ]
}
```

## iPhone 捷徑設定

### 步驟

1. 打開「捷徑」App → 新增捷徑
2. 加入以下動作：

```
1. 「取得檔案」→ 來源選擇「錄音」
                    ↓
2. 「URL」→ http://NAS_IP/voice-sync/upload.php
                    ↓
3. 「取得內容」→ 設定：
   - 方法：POST
   - 要求本文：選擇「檔案」→ 拖入步驟 1 的錄音
```

### 捷徑流程圖

```
[取得 iPhone 錄音] → [POST 到 upload.php] → [顯示成功訊息]
                                        ↓
                                  [背景轉文字]
```

## 部署步驟

### NAS SSH 指令

```bash
# 1. 建立目錄
sudo mkdir -p /web/voice-sync/data/{recordings,transcripts}
sudo chown -R http:http /web/voice-sync

# 2. 上傳程式碼
# 使用 File Station 或 SCP 上傳所有檔案到 /web/voice-sync/

# 3. 設定權限
chmod -R 755 /web/voice-sync

# 4. Web Station 設定
# 新增網站 → 根目錄 = /web/voice-sync
```

### config.php 設定

```php
define('OPENAI_API_KEY', 'sk-xxxxxxxxxxxxxxxxxxxx');  // 填入你的 API Key
```

### 取得 OpenAI API Key

1. 前往 https://platform.openai.com/api-keys
2. 登入 → Create new secret key
3. 複製並填入 config.php

## 費用

| 服務 | 費用 |
|------|------|
| OpenAI Whisper API | $0.006/分鐘 |
| 1 分鐘錄音 | 約 NT$0.2 |

## 備註

- 轉錄時間：約 3-5 秒
- 支援語言：中文（繁體）
- 背景執行，不會卡住上傳介面
