# 錄音程式系統 (Voice Recording System)

## 上傳方式

### 方式一：iPhone 捷徑

```
iPhone 捷徑 → [POST 上傳] → NAS PHP 程式 → [OpenAI Whisper API] → 文字稿(.md)
                                    ↓
                              [index.json] 索引
```

### 方式二：Telegram 傳送錄音檔

```
Telegram 傳送錄音檔 → OpenClaw 接收 → [Whisper 轉文字] → 同步到 NAS
                                        ↓
                              [index.json + .md 自動更新]
```

OpenClaw 處理流程：
1. 接收 Telegram 錄音檔 (m4a/mp3)
2. 使用 Whisper 本機轉文字
3. 產生 `.md` 檔案
4. 更新 `index.json` 索引
5. 透過 SMB 同步到 NAS：`\\192.168.1.13\web\voice-sync/data/`

## 環境需求

| 項目 | 版本/需求 |
|------|-----------|
| NAS | Synology DS218j (DSM 6.2.4) |
| Web Server | Synology Web Station |
| PHP | 7.x+ |
| API | OpenAI Whisper API ($0.006/分鐘) |

## 目錄結構

```
/web/voice-sync/
├── index.php          # 檔案列表 + 分頁
├── upload.php         # 接收上傳 + API 轉文字
├── api.php            # 搜尋 API
├── config.php         # 設定檔（API Key）
└── data/
    ├── recordings/   # 錄音檔 (.m4a, .mp3)
    ├── transcripts/   # 語音轉文字 (.md)
    └── index.json     # 索引資料庫
```

## 程式碼

### 1. config.php

```php
<?php
define('DATA_DIR', __DIR__ . '/data');
define('RECORDINGS_DIR', DATA_DIR . '/recordings');
define('TRANSCRIPTS_DIR', DATA_DIR . '/transcripts');
define('INDEX_FILE', DATA_DIR . '/index.json');
define('ITEMS_PER_PAGE', 40);

// OpenAI Whisper API
define('OPENAI_API_KEY', 'YOUR_OPENAI_API_KEY');
define('OPENAI_API_URL', 'https://api.openai.com/v1/audio/transcriptions');
```

### 2. index.php（檔案列表 + 分頁 + 點擊查看文字稿）

```php
<?
require_once 'config.php';

$index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
$files = $index['files'] ?? [];

usort($files, function($a, $b) {
    return strtotime($b['date']) - strtotime($a['date']);
});

$page = max(1, intval($_GET['page'] ?? 1));
$totalPages = ceil(count($files) / ITEMS_PER_PAGE);
$start = ($page - 1) * ITEMS_PER_PAGE;
$pageFiles = array_slice($files, $start, $ITEMS_PER_PAGE);

function formatDuration($seconds) {
    $m = floor($seconds / 60);
    $s = $seconds % 60;
    return sprintf('%d:%02d', $m, $s);
}
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>錄音檔列表</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .filename { color: #007bff; text-decoration: none; }
        .filename:hover { text-decoration: underline; }
        .pagination { margin: 20px 0; display: flex; gap: 5px; }
        .pagination a { padding: 8px 12px; background: white; border: 1px solid #ddd; text-decoration: none; }
        .pagination a.active { background: #007bff; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>錄音檔列表</h1>
        <table>
            <thead>
                <tr>
                    <th>日期</th>
                    <th>檔名</th>
                    <th>長度</th>
                    <th>大小</th>
                    <th>狀態</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($pageFiles as $file): ?>
                <tr>
                    <td><?= htmlspecialchars($file['date']) ?></td>
                    <td>
                        <?php if (file_exists(TRANSCRIPTS_DIR . '/' . $file['id'] . '.md')): ?>
                            <a href="view.php?id=<?= urlencode($file['id']) ?>" class="filename">
                                <?= htmlspecialchars($file['filename']) ?>
                            </a>
                        <?php else: ?>
                            <?= htmlspecialchars($file['filename']) ?>
                        <?php endif; ?>
                    </td>
                    <td><?= formatDuration($file['duration']) ?></td>
                    <td><?= round($file['size'] / 1024) ?> KB</td>
                    <td>
                        <?php if (file_exists(TRANSCRIPTS_DIR . '/' . $file['id'] . '.md')): ?>
                            <span style="color: green;">已完成</span>
                        <?php else: ?>
                            <span style="color: orange;">轉錄中...</span>
                        <?php endif; ?>
                    </td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
        <div class="pagination">
            <?php for ($i = 1; $i <= $totalPages; $i++): ?>
                <a href="?page=<?= $i ?>" class="<?= $i === $page ? 'active' : '' ?>"><?= $i ?></a>
            <?php endfor; ?>
        </div>
    </div>
</body>
</html>
```

### 3. upload.php（上傳 + 背景轉文字）

```php
<?php
require_once 'config.php';

// 建立資料夾
if (!is_dir(RECORDINGS_DIR)) mkdir(RECORDINGS_DIR, 0755, true);
if (!is_dir(TRANSCRIPTS_DIR)) mkdir(TRANSCRIPTS_DIR, 0755, true);

// 處理上傳
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['audio'])) {
    $file = $_FILES['audio'];
    $originalName = basename($file['name']);
    $fileId = time() . '_' . substr(md5($originalName), 0, 8);
    $extension = strtolower(pathinfo($originalName, PATHINFO_EXTENSION)) ?: 'm4a';
    
    $recordingsPath = RECORDINGS_DIR . '/' . $fileId . '.' . $extension;
    $transcriptPath = TRANSCRIPTS_DIR . '/' . $fileId . '.md';
    
    if (move_uploaded_file($file['tmp_name'], $recordingsPath)) {
        // 更新 index.json
        $index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
        $index['files'][] = [
            'id' => $fileId,
            'filename' => $originalName,
            'path' => 'recordings/' . $fileId . '.' . $extension,
            'transcript_path' => 'transcripts/' . $fileId . '.md',
            'date' => date('Y-m-d H:i:s'),
            'duration' => 0,
            'size' => filesize($recordingsPath),
            'status' => 'pending'
        ];
        file_put_contents(INDEX_FILE, json_encode($index, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
        
        // 背景執行 Whisper API
        $scriptPath = DATA_DIR . '/transcribe_' . $fileId . '.php';
        $script = '<?php
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, "' . OPENAI_API_URL . '");
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, ["Authorization: Bearer ' . OPENAI_API_KEY . '"]);
curl_setopt($ch, CURLOPT_POSTFIELDS, [
    "file" => new CURLFile("' . $recordingsPath . '", "audio/mpeg", "' . $originalName . '"),
    "model" => "whisper-1",
    "language" => "zh"
]);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$response = curl_exec($ch);
curl_close($ch);
$result = json_decode($response, true);
if (isset($result["text"])) {
    file_put_contents("' . $transcriptPath . '", $result["text"]);
}
unlink(__FILE__);
';
        file_put_contents($scriptPath, $script);
        exec("nohup php $scriptPath > /dev/null 2>&1 &");
        
        echo json_encode(['success' => true, 'id' => $fileId, 'message' => '上傳成功，轉錄中...']);
    }
}
```

### 3. view.php（文字稿檢視）

```php
<?
require_once 'config.php';

$id = $_GET['id'] ?? '';
if (!$id) {
    header('Location: index.php');
    exit;
}

// 取得錄音檔資訊
$index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
$files = $index['files'] ?? [];
$file = null;
foreach ($files as $f) {
    if ($f['id'] === $id) {
        $file = $f;
        break;
    }
}

if (!$file) {
    echo '找不到該錄音檔';
    exit;
}

// 讀取文字稿
$transcriptPath = TRANSCRIPTS_DIR . '/' . $id . '.md';
$transcriptContent = file_exists($transcriptPath) ? file_get_contents($transcriptPath) : '轉錄中...';
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title><?= htmlspecialchars($file['filename']) ?> - 文字稿</title>
    <style>
        body { font-family: system-ui, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        .file-info { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .transcript { background: white; padding: 20px; border-radius: 8px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.php" class="back-link">← 返回列表</a>
        <div class="file-info">
            <h2><?= htmlspecialchars($file['filename']) ?></h2>
            <p>日期：<?= htmlspecialchars($file['date']) ?></p>
        </div>
        <div class="transcript"><?= htmlspecialchars($transcriptContent) ?></div>
    </div>
</body>
</html>
```

### 4. api.php（搜尋）

```php
<?php
require_once 'config.php';

$index = file_exists(INDEX_FILE) ? json_decode(file_get_contents(INDEX_FILE), true) : ['files' => []];
$files = $index['files'] ?? [];

$query = trim($_GET['q'] ?? '');

if ($query) {
    $results = [];
    foreach ($files as $file) {
        $transcriptPath = TRANSCRIPTS_DIR . '/' . $file['id'] . '.md';
        if (file_exists($transcriptPath)) {
            $content = file_get_contents($transcriptPath);
            if (stripos($content, $query) !== false) {
                $results[] = [
                    'file' => $file,
                    'preview' => mb_substr($content, 0, 200) . '...'
                ];
            }
        }
    }
    header('Content-Type: application/json; charset=UTF-8');
    echo json_encode(['results' => $results, 'count' => count($results)], JSON_UNESCAPED_UNICODE);
}
```

## 資料結構

### index.json 範例

```json
{
  "files": [
    {
      "id": "1707187200_abc123",
      "filename": "錄音.m4a",
      "path": "recordings/1707187200_abc123.m4a",
      "transcript_path": "transcripts/1707187200_abc123.md",
      "date": "2024-02-06 00:00:00",
      "duration": 0,
      "size": 1024000,
      "status": "done"
    }
  ]
}
```

## iPhone 捷徑設定

### 步驟

1. 打開「捷徑」App → 新增捷徑
2. 加入以下動作：

```
1. 「取得檔案」→ 來源選擇「錄音」
                    ↓
2. 「URL」→ http://NAS_IP/voice-sync/upload.php
                    ↓
3. 「取得內容」→ 設定：
   - 方法：POST
   - 要求本文：選擇「檔案」→ 拖入步驟 1 的錄音
```

### 捷徑流程圖

```
[取得 iPhone 錄音] → [POST 到 upload.php] → [顯示成功訊息]
                                        ↓
                                  [背景轉文字]
```

## 部署步驟

### NAS SSH 指令

```bash
# 1. 建立目錄
sudo mkdir -p /web/voice-sync/data/{recordings,transcripts}
sudo chown -R http:http /web/voice-sync

# 2. 上傳程式碼
# 使用 File Station 或 SCP 上傳所有檔案到 /web/voice-sync/

# 3. 設定權限
chmod -R 755 /web/voice-sync

# 4. Web Station 設定
# 新增網站 → 根目錄 = /web/voice-sync
```

### config.php 設定

```php
define('OPENAI_API_KEY', 'sk-xxxxxxxxxxxxxxxxxxxx');  // 填入你的 API Key
```

### 取得 OpenAI API Key

1. 前往 https://platform.openai.com/api-keys
2. 登入 → Create new secret key
3. 複製並填入 config.php

## 費用

| 服務 | 費用 |
|------|------|
| OpenAI Whisper API | $0.006/分鐘 |
| 1 分鐘錄音 | 約 NT$0.2 |

## 備註

- 轉錄時間：約 3-5 秒
- 支援語言：中文（繁體）
- 背景執行，不會卡住上傳介面
